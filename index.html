<!DOCTYPE html>
<html>
<head>
    <title>NEET Admin Panel - 10 Weeks with Full Image Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ========== ALL CSS IN ONE FILE ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #2d3748; 
            margin-bottom: 20px; 
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            flex-wrap: wrap;
            margin-bottom: 30px; 
            border-bottom: 2px solid #e2e8f0;
        }
        .tab { 
            padding: 12px 25px; 
            cursor: pointer; 
            background: #f7fafc; 
            border: 1px solid #e2e8f0;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab:hover { background: #edf2f7; }
        .tab.active { 
            background: #667eea; 
            color: white; 
            border-color: #667eea;
            position: relative;
            top: 1px;
        }
        
        /* Tab Content */
        .content { 
            display: none; 
            padding: 25px; 
            background: #f8f9fa; 
            border-radius: 0 8px 8px 8px;
            border: 1px solid #e2e8f0;
            border-top: none;
        }
        .content.active { display: block; }
        
        /* Week Boxes */
        .week-boxes { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; 
            margin: 20px 0;
        }
        .week-box { 
            height: 100px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s;
            border: 3px solid;
            padding: 10px;
        }
        .week-box.empty { 
            background: #e2e8f0; 
            border-color: #cbd5e0;
            color: #718096;
        }
        .week-box.partial { 
            background: #fff3cd; 
            border-color: #ffc107;
            color: #856404;
        }
        .week-box.full { 
            background: #d4edda; 
            border-color: #28a745;
            color: #155724;
        }
        .week-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .week-box.selected { 
            background: #667eea; 
            border-color: #5a67d8;
            color: white;
            transform: scale(1.05);
        }
        .week-number {
            font-size: 24px;
            font-weight: bold;
        }
        .week-count {
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Forms */
        input, select, textarea {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            margin: 8px 0;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600;
            color: #4a5568;
        }
        
        /* Buttons */
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }
        button:hover { 
            background: #5a67d8; 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button.green { background: #48bb78; }
        button.green:hover { background: #38a169; }
        button.red { background: #f56565; }
        button.red:hover { background: #e53e3e; }
        button.yellow { background: #ecc94b; color: #744210; }
        button.yellow:hover { background: #d69e2e; }
        button.blue { background: #4299e1; }
        button.blue:hover { background: #3182ce; }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            text-align: left;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) { background: #f7fafc; }
        tr:hover { background: #edf2f7; }
        
        /* JSON Editor */
        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 300px;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Image Upload Areas */
        .image-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .image-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .image-upload-area.small {
            padding: 10px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin-bottom: 10px;
        }
        .image-preview.small {
            max-height: 80px;
        }
        .remove-image-btn {
            padding: 5px 10px;
            font-size: 12px;
            background: #f56565;
            margin-top: 5px;
        }
        
        /* Options Grid with Images */
        .options-with-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .option-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .option-card label {
            margin-bottom: 10px;
            color: #4a5568;
        }
        
        /* Question Card with Images */
        .question-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .question-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        .option-image {
            max-width: 100px;
            max-height: 60px;
            border-radius: 4px;
            margin-left: 10px;
            vertical-align: middle;
            border: 1px solid #e2e8f0;
        }
        .option-with-image {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        /* Certificate Styling - ORIGINAL WAPIS */
        .certificate-container {
            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
            border: 5px solid gold;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .certificate-title {
            color: #1e3a8a;
            font-size: 32px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .certificate-name {
            color: #3730a3;
            font-size: 36px;
            margin: 20px 0;
            padding: 10px;
            border-bottom: 3px solid #fbbf24;
            display: inline-block;
        }
        .certificate-details {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin: 30px auto;
            max-width: 600px;
            border: 2px solid #e2e8f0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .tab { padding: 10px 15px; font-size: 14px; }
            .week-box { height: 80px; font-size: 14px; }
            .week-number { font-size: 20px; }
            .options-with-images {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã NEET Admin Panel - 10 Weeks (Full Image Support)</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">üì§ Upload Questions</div>
            <div class="tab" onclick="showTab('schedule')">üìÖ 10 Weeks</div>
            <div class="tab" onclick="showTab('users')">üë• Student Progress</div>
            <div class="tab" onclick="showTab('certificates')">üèÜ Certificate Generator</div>
        </div>
        
        <!-- Tab 1: Upload Questions -->
        <div id="upload" class="content active">
            <h2>Upload Questions for Week</h2>
            
            <div class="form-group">
                <label>Select Week:</label>
                <select id="weekSelect" onchange="loadWeekQuestions(this.value)">
                    <option value="">-- Select Week (1-10) --</option>
                    <option value="1">Week 1</option>
                    <option value="2">Week 2</option>
                    <option value="3">Week 3</option>
                    <option value="4">Week 4</option>
                    <option value="5">Week 5</option>
                    <option value="6">Week 6</option>
                    <option value="7">Week 7</option>
                    <option value="8">Week 8</option>
                    <option value="9">Week 9</option>
                    <option value="10">Week 10</option>
                </select>
            </div>
            
            <div id="weekInfo" style="display: none; background: #e6f7ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h3>Week <span id="selectedWeek">1</span></h3>
                <p><strong>Status:</strong> <span id="selectedStatus">0/180 questions uploaded</span></p>
            </div>
            
            <h3>Method 1: Upload JSON (180 Questions)</h3>
            <p style="color: #666; margin-bottom: 10px;">Format: 180 questions per week (with image support for question and options)</p>
            <textarea id="jsonUpload" class="json-editor" placeholder='{
  "week": 1,
  "questions": [
    {
      "id": 1,
      "question": "Your question text here?",
      "questionImage": "data:image/png;base64,iVBORw0KG... (optional)",
      "options": {
        "A": { "text": "Option A text", "image": "data:image/..." },
        "B": { "text": "Option B text", "image": "data:image/..." },
        "C": { "text": "Option C text", "image": null },
        "D": { "text": "Option D text", "image": null }
      },
      "answer": "C",
      "explanation": "Detailed explanation here",
      "explanationImage": "data:image/... (optional)"
    }
  ]
}'></textarea>
            <button onclick="uploadJSON()" class="green">üì§ Upload JSON for Selected Week</button>
            
            <h3 style="margin-top: 40px;">Method 2: Add Single Question with Multiple Images</h3>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px dashed #3b82f6;">
                <div class="form-group">
                    <label>Question Number (1-180):</label>
                    <input type="number" id="qNumber" min="1" max="180" placeholder="1">
                </div>
                
                <!-- Question Image -->
                <div class="form-group">
                    <label>Question Image (Optional):</label>
                    <div class="image-upload-area" 
                         onclick="document.getElementById('questionImageInput').click()"
                         ondragover="event.preventDefault()"
                         ondrop="handleQuestionImageDrop(event)">
                        
                        <input type="file" id="questionImageInput" accept="image/*" style="display: none;" onchange="handleQuestionImageSelect(event)">
                        
                        <div id="questionImagePreviewArea" style="display: none;">
                            <img id="questionImagePreview" src="#" class="image-preview">
                            <button type="button" onclick="removeQuestionImage(event)" class="remove-image-btn red">‚ùå Remove Image</button>
                        </div>
                        
                        <div id="questionImagePlaceholder">
                            <span style="font-size: 32px;">üì∑</span>
                            <p style="color: #4a5568; margin: 5px 0;">Click to upload question image</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Question Text:</label>
                    <textarea id="questionText" placeholder="Enter your question here..." rows="3"></textarea>
                </div>
                
                <h4 style="margin: 20px 0 10px;">Options (with Image Support)</h4>
                <div class="options-with-images">
                    <!-- Option A -->
                    <div class="option-card">
                        <label>Option A:</label>
                        <div class="image-upload-area small" 
                             onclick="document.getElementById('optionAImageInput').click()"
                             ondragover="event.preventDefault()"
                             ondrop="handleOptionImageDrop(event, 'A')">
                            
                            <input type="file" id="optionAImageInput" accept="image/*" style="display: none;" onchange="handleOptionImageSelect(event, 'A')">
                            
                            <div id="optionAImagePreviewArea" style="display: none;">
                                <img id="optionAImagePreview" src="#" class="image-preview small">
                                <button type="button" onclick="removeOptionImage(event, 'A')" class="remove-image-btn red">‚ùå</button>
                            </div>
                            
                            <div id="optionAImagePlaceholder">
                                <span>‚ûï Add Image</span>
                            </div>
                        </div>
                        <input type="text" id="optA" placeholder="Option A text">
                    </div>
                    
                    <!-- Option B -->
                    <div class="option-card">
                        <label>Option B:</label>
                        <div class="image-upload-area small" 
                             onclick="document.getElementById('optionBImageInput').click()"
                             ondragover="event.preventDefault()"
                             ondrop="handleOptionImageDrop(event, 'B')">
                            
                            <input type="file" id="optionBImageInput" accept="image/*" style="display: none;" onchange="handleOptionImageSelect(event, 'B')">
                            
                            <div id="optionBImagePreviewArea" style="display: none;">
                                <img id="optionBImagePreview" src="#" class="image-preview small">
                                <button type="button" onclick="removeOptionImage(event, 'B')" class="remove-image-btn red">‚ùå</button>
                            </div>
                            
                            <div id="optionBImagePlaceholder">
                                <span>‚ûï Add Image</span>
                            </div>
                        </div>
                        <input type="text" id="optB" placeholder="Option B text">
                    </div>
                    
                    <!-- Option C -->
                    <div class="option-card">
                        <label>Option C:</label>
                        <div class="image-upload-area small" 
                             onclick="document.getElementById('optionCImageInput').click()"
                             ondragover="event.preventDefault()"
                             ondrop="handleOptionImageDrop(event, 'C')">
                            
                            <input type="file" id="optionCImageInput" accept="image/*" style="display: none;" onchange="handleOptionImageSelect(event, 'C')">
                            
                            <div id="optionCImagePreviewArea" style="display: none;">
                                <img id="optionCImagePreview" src="#" class="image-preview small">
                                <button type="button" onclick="removeOptionImage(event, 'C')" class="remove-image-btn red">‚ùå</button>
                            </div>
                            
                            <div id="optionCImagePlaceholder">
                                <span>‚ûï Add Image</span>
                            </div>
                        </div>
                        <input type="text" id="optC" placeholder="Option C text">
                    </div>
                    
                    <!-- Option D -->
                    <div class="option-card">
                        <label>Option D:</label>
                        <div class="image-upload-area small" 
                             onclick="document.getElementById('optionDImageInput').click()"
                             ondragover="event.preventDefault()"
                             ondrop="handleOptionImageDrop(event, 'D')">
                            
                            <input type="file" id="optionDImageInput" accept="image/*" style="display: none;" onchange="handleOptionImageSelect(event, 'D')">
                            
                            <div id="optionDImagePreviewArea" style="display: none;">
                                <img id="optionDImagePreview" src="#" class="image-preview small">
                                <button type="button" onclick="removeOptionImage(event, 'D')" class="remove-image-btn red">‚ùå</button>
                            </div>
                            
                            <div id="optionDImagePlaceholder">
                                <span>‚ûï Add Image</span>
                            </div>
                        </div>
                        <input type="text" id="optD" placeholder="Option D text">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Correct Answer:</label>
                    <select id="correctOption">
                        <option value="">Select correct option</option>
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>
                
                <!-- Explanation with Image -->
                <div class="form-group">
                    <label>Explanation (Optional):</label>
                    <textarea id="explanation" placeholder="Add explanation here..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Explanation Image (Optional):</label>
                    <div class="image-upload-area" 
                         onclick="document.getElementById('explanationImageInput').click()"
                         ondragover="event.preventDefault()"
                         ondrop="handleExplanationImageDrop(event)">
                        
                        <input type="file" id="explanationImageInput" accept="image/*" style="display: none;" onchange="handleExplanationImageSelect(event)">
                        
                        <div id="explanationImagePreviewArea" style="display: none;">
                            <img id="explanationImagePreview" src="#" class="image-preview">
                            <button type="button" onclick="removeExplanationImage(event)" class="remove-image-btn red">‚ùå Remove</button>
                        </div>
                        
                        <div id="explanationImagePlaceholder">
                            <span>‚ûï Add Explanation Image</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="addSingleQuestionWithImages()" class="green">‚ûï Add Question with Images</button>
                    <button onclick="clearAllImages()" class="yellow">üîÑ Clear All Images</button>
                    <button onclick="addAllSampleQuestions()" class="blue">‚ö° Add 180 Sample Questions</button>
                </div>
            </div>
            
            <h3 style="margin-top: 40px;">Current Questions for Week <span id="currentWeekDisplay">1</span></h3>
            <div id="questionsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Tab 2: 10 Weeks Schedule (Simple) -->
        <div id="schedule" class="content">
            <h2>10-Week NEET Schedule (Feb 19 - May 3, 2026)</h2>
            <p style="color: #666; margin-bottom: 20px;">Click any week to view/edit questions (180 questions each)</p>
            
            <div class="week-boxes" id="weekBoxes"></div>
            
            <div id="weekDetails" style="display: none; margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
                <h3>Week <span id="detailWeek">1</span> Details</h3>
                <div style="margin-top: 20px;">
                    <p><strong>üìä Status:</strong> <span id="detailStatus">Pending</span></p>
                    <p><strong>‚ùì Questions:</strong> <span id="detailQuestions">0/180 uploaded</span></p>
                    <p><strong>üîÑ Last Updated:</strong> <span id="detailUpdated">Never</span></p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="goToWeekEdit()" class="green">‚úèÔ∏è Edit This Week's Questions</button>
                    <button onclick="clearWeekQuestions()" class="red">üóëÔ∏è Clear All Questions</button>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: User Progress -->
        <div id="users" class="content">
            <h2>Student Progress Tracking</h2>
            <div style="margin: 20px 0;">
                <button onclick="loadAllUsers()" class="green">üîÑ Refresh Data</button>
                <input type="text" id="searchUser" placeholder="üîç Search by name..." style="padding: 10px; width: 300px; margin-left: 20px;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Username</th>
                        <th>Current Week</th>
                        <th>Progress</th>
                        <th>Avg Score</th>
                        <th>Tests Taken</th>
                        <th>Last Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
        
        <!-- Tab 4: Certificate Generator - ORIGINAL WAPIS -->
        <div id="certificates" class="content">
            <h2>üéì Certificate Generator</h2>
            
            <div class="form-group">
                <label>Select Student:</label>
                <select id="certStudent" style="width: 100%; padding: 12px;">
                    <option value="">-- Select Student --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Certificate Type:</label>
                <select id="certType" style="width: 100%; padding: 12px;">
                    <option value="completion">üèÜ Completion Certificate (All 10 Weeks)</option>
                    <option value="progress">üìà Progress Certificate (Partial Completion)</option>
                    <option value="excellence">‚≠ê Excellence Certificate (Top Performance)</option>
                </select>
            </div>
            
            <div style="margin: 20px 0;">
                <button onclick="generateCertificate()" class="green">üéì Generate Certificate</button>
                <button onclick="previewCertificate()" class="blue">üëÅÔ∏è Preview Certificate</button>
            </div>
            
            <div id="certificatePreview" class="certificate-container" style="display: none;">
                <h1 class="certificate-title" id="certTitle">Certificate of Completion</h1>
                
                <p style="color: #4b5563; font-size: 18px; margin: 20px 0;">This is to certify that</p>
                
                <h2 class="certificate-name" id="certStudentName">Student Name</h2>
                
                <p style="color: #6b7280; font-size: 16px; line-height: 1.6; margin: 20px 0;">
                    has successfully completed the 10-week NEET preparation program
                    demonstrating exceptional dedication and commitment to academic excellence.
                </p>
                
                <div class="certificate-details">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; text-align: left;">
                        <div>
                            <p style="color: #4b5563; margin: 5px 0;"><strong>Program Duration:</strong></p>
                            <p style="color: #1f2937; font-weight: 600;">10 Weeks (Feb 19 - May 3, 2026)</p>
                        </div>
                        <div>
                            <p style="color: #4b5563; margin: 5px 0;"><strong>Overall Performance:</strong></p>
                            <p style="color: #1f2937; font-weight: 600;" id="certPerformance">92% Average Score</p>
                        </div>
                        <div>
                            <p style="color: #4b5563; margin: 5px 0;"><strong>Certificate ID:</strong></p>
                            <p style="color: #1f2937; font-weight: 600;" id="certId">NEET2026-ABC123</p>
                        </div>
                        <div>
                            <p style="color: #4b5563; margin: 5px 0;"><strong>Issued Date:</strong></p>
                            <p style="color: #1f2937; font-weight: 600;" id="certIssuedDate">May 3, 2026</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button onclick="printCertificate()" class="green">üñ®Ô∏è Print Certificate</button>
                    <button onclick="downloadCertificate()" class="blue">üì• Download as PDF</button>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <p style="color: #6b7280; font-size: 12px;">
                        <strong>Official Seal:</strong> NEET Preparation Portal<br>
                        <strong>Issuing Authority:</strong> NEET Exam Preparation Committee
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========== FIREBASE AND JAVASCRIPT ========== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDQllntvhYYX2_SgZh7eUna1ZCl1_Pk5iE",
            authDomain: "neet-practise-4x.firebaseapp.com",
            databaseURL: "https://neet-practise-4x-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "neet-practise-4x",
            storageBucket: "neet-practise-4x.firebasestorage.app",
            messagingSenderId: "580564387981",
            appId: "1:580564387981:web:14bca0642e18e2b568bac4"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        
        // ========== GLOBAL VARIABLES ==========
        let currentSelectedWeek = 1;
        let currentSelectedUser = null;
        
        // Image variables
        let currentQuestionImage = null;
        let currentOptionImages = { A: null, B: null, C: null, D: null };
        let currentExplanationImage = null;
        
        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NEET Admin Panel Loaded');
            generateWeekBoxes();
            loadAllUsers();
            populateCertificateStudents();
        });
        
        // ========== TAB FUNCTIONS ==========
        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // ========== WEEK BOXES ==========
        function generateWeekBoxes() {
            const container = document.getElementById('weekBoxes');
            container.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const weekBox = document.createElement('div');
                weekBox.className = 'week-box empty';
                weekBox.innerHTML = `
                    <div class="week-number">Week ${i}</div>
                    <div class="week-count">0/180</div>
                `;
                weekBox.onclick = () => selectWeekBox(i);
                container.appendChild(weekBox);
            }
            
            updateAllWeekBoxes();
        }
        
        function selectWeekBox(weekNum) {
            currentSelectedWeek = weekNum;
            
            document.getElementById('weekSelect').value = weekNum;
            document.getElementById('selectedWeek').textContent = weekNum;
            document.getElementById('weekInfo').style.display = 'block';
            
            loadWeekQuestions(weekNum);
            
            document.getElementById('detailWeek').textContent = weekNum;
            document.getElementById('weekDetails').style.display = 'block';
            
            document.querySelectorAll('.week-box').forEach(box => {
                box.classList.remove('selected');
            });
            document.querySelectorAll('.week-box')[weekNum-1].classList.add('selected');
            
            showTab('upload');
        }
        
        // ========== IMAGE HANDLING FUNCTIONS ==========
        
        // Question Image
        function handleQuestionImageSelect(event) {
            const file = event.target.files[0];
            if (file) convertToBase64(file, 'question');
        }
        
        function handleQuestionImageDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                convertToBase64(file, 'question');
            }
        }
        
        // Option Images
        function handleOptionImageSelect(event, option) {
            const file = event.target.files[0];
            if (file) convertToBase64(file, 'option', option);
        }
        
        function handleOptionImageDrop(event, option) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                convertToBase64(file, 'option', option);
            }
        }
        
        // Explanation Image
        function handleExplanationImageSelect(event) {
            const file = event.target.files[0];
            if (file) convertToBase64(file, 'explanation');
        }
        
        function handleExplanationImageDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                convertToBase64(file, 'explanation');
            }
        }
        
        // Base64 Converter
        function convertToBase64(file, type, option = null) {
            if (file.size > 5 * 1024 * 1024) {
                alert('Image too large! Maximum size is 5MB');
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const base64 = reader.result;
                
                if (type === 'question') {
                    currentQuestionImage = base64;
                    document.getElementById('questionImagePreview').src = base64;
                    document.getElementById('questionImagePreviewArea').style.display = 'block';
                    document.getElementById('questionImagePlaceholder').style.display = 'none';
                }
                else if (type === 'option' && option) {
                    currentOptionImages[option] = base64;
                    document.getElementById(`option${option}ImagePreview`).src = base64;
                    document.getElementById(`option${option}ImagePreviewArea`).style.display = 'block';
                    document.getElementById(`option${option}ImagePlaceholder`).style.display = 'none';
                }
                else if (type === 'explanation') {
                    currentExplanationImage = base64;
                    document.getElementById('explanationImagePreview').src = base64;
                    document.getElementById('explanationImagePreviewArea').style.display = 'block';
                    document.getElementById('explanationImagePlaceholder').style.display = 'none';
                }
            };
        }
        
        // Remove Functions
        function removeQuestionImage(event) {
            event.stopPropagation();
            currentQuestionImage = null;
            document.getElementById('questionImagePreviewArea').style.display = 'none';
            document.getElementById('questionImagePlaceholder').style.display = 'block';
            document.getElementById('questionImageInput').value = '';
        }
        
        function removeOptionImage(event, option) {
            event.stopPropagation();
            currentOptionImages[option] = null;
            document.getElementById(`option${option}ImagePreviewArea`).style.display = 'none';
            document.getElementById(`option${option}ImagePlaceholder`).style.display = 'block';
            document.getElementById(`option${option}ImageInput`).value = '';
        }
        
        function removeExplanationImage(event) {
            event.stopPropagation();
            currentExplanationImage = null;
            document.getElementById('explanationImagePreviewArea').style.display = 'none';
            document.getElementById('explanationImagePlaceholder').style.display = 'block';
            document.getElementById('explanationImageInput').value = '';
        }
        
        function clearAllImages() {
            // Clear question image
            currentQuestionImage = null;
            document.getElementById('questionImagePreviewArea').style.display = 'none';
            document.getElementById('questionImagePlaceholder').style.display = 'block';
            document.getElementById('questionImageInput').value = '';
            
            // Clear option images
            ['A', 'B', 'C', 'D'].forEach(opt => {
                currentOptionImages[opt] = null;
                document.getElementById(`option${opt}ImagePreviewArea`).style.display = 'none';
                document.getElementById(`option${opt}ImagePlaceholder`).style.display = 'block';
                document.getElementById(`option${opt}ImageInput`).value = '';
            });
            
            // Clear explanation image
            currentExplanationImage = null;
            document.getElementById('explanationImagePreviewArea').style.display = 'none';
            document.getElementById('explanationImagePlaceholder').style.display = 'block';
            document.getElementById('explanationImageInput').value = '';
        }
        
        // ========== QUESTION MANAGEMENT ==========
        function loadWeekQuestions(weekNum) {
            if (!weekNum) return;
            
            database.ref(`questions/week${weekNum}`).once('value')
                .then(snapshot => {
                    const questions = snapshot.val();
                    const count = snapshot.numChildren() || 0;
                    
                    document.getElementById('selectedStatus').textContent = `${count}/180 questions uploaded`;
                    document.getElementById('detailQuestions').textContent = `${count}/180 uploaded`;
                    document.getElementById('detailStatus').textContent = count >= 180 ? 'Complete' : count > 0 ? 'Partial' : 'Empty';
                    document.getElementById('currentWeekDisplay').textContent = weekNum;
                    
                    updateWeekBoxStatus(weekNum, count);
                    displayQuestionsList(questions);
                });
        }
        
        function displayQuestionsList(questions) {
            const container = document.getElementById('questionsList');
            
            if (!questions || Object.keys(questions).length === 0) {
                container.innerHTML = '<p style="color: #718096; padding: 20px; text-align: center; background: #f7fafc; border-radius: 8px;">No questions uploaded yet for this week.</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 20px;">';
            
            Object.entries(questions).forEach(([key, q]) => {
                const qNum = key.replace('q', '');
                
                html += `
                    <div class="question-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: #2d3748; font-size: 18px;">Question ${qNum}:</strong>
                            </div>
                            <button onclick="deleteQuestion(${currentSelectedWeek}, '${key}')" style="padding: 5px 10px; font-size: 12px;" class="red">Delete</button>
                        </div>
                        
                        ${q.questionImage ? `<img src="${q.questionImage}" class="question-image" alt="Question Image">` : ''}
                        
                        <div style="margin: 15px 0; font-size: 16px;">${q.question}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            ${renderOptionWithImage('A', q.options?.A, q.answer)}
                            ${renderOptionWithImage('B', q.options?.B, q.answer)}
                            ${renderOptionWithImage('C', q.options?.C, q.answer)}
                            ${renderOptionWithImage('D', q.options?.D, q.answer)}
                        </div>
                        
                        ${q.explanation ? `
                            <div style="margin-top: 15px; padding: 15px; background: #e6f7ff; border-radius: 8px;">
                                <strong>Explanation:</strong> ${q.explanation}
                                ${q.explanationImage ? `<br><img src="${q.explanationImage}" class="question-image" style="max-height: 100px; margin-top: 10px;">` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderOptionWithImage(letter, optionData, correctAnswer) {
            if (!optionData) return '';
            
            const isCorrect = correctAnswer === letter;
            const text = typeof optionData === 'object' ? optionData.text : optionData;
            const image = typeof optionData === 'object' ? optionData.image : null;
            
            return `
                <div style="border: 2px solid ${isCorrect ? '#48bb78' : '#e2e8f0'}; border-radius: 8px; padding: 10px; background: ${isCorrect ? '#f0fff4' : 'white'};">
                    <div class="option-with-image">
                        <strong style="color: ${isCorrect ? '#48bb78' : '#718096'};">${letter}.</strong>
                        <span>${text || ''}</span>
                        ${image ? `<img src="${image}" class="option-image" alt="Option ${letter}">` : ''}
                    </div>
                    ${isCorrect ? '<span style="color: #48bb78; font-size: 12px;">‚úì Correct Answer</span>' : ''}
                </div>
            `;
        }
        
        // ========== UPLOAD FUNCTIONS ==========
        function uploadJSON() {
            const weekNum = currentSelectedWeek;
            const jsonText = document.getElementById('jsonUpload').value;
            
            if (!weekNum) {
                alert('Please select a week first.');
                return;
            }
            
            if (!jsonText) {
                alert('Please paste JSON data.');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                
                if (!data.questions || !Array.isArray(data.questions)) {
                    throw new Error('JSON must contain "questions" array');
                }
                
                if (data.questions.length !== 180) {
                    throw new Error(`Exactly 180 questions required. You provided ${data.questions.length}`);
                }
                
                const updates = {};
                const questions = {};
                
                data.questions.forEach((q, index) => {
                    if (!q.question || !q.options || !q.answer) {
                        throw new Error(`Question ${index + 1} is missing required fields`);
                    }
                    
                    const questionId = `q${index + 1}`;
                    questions[questionId] = {
                        question: q.question,
                        questionImage: q.questionImage || null,
                        options: q.options,
                        answer: q.answer,
                        explanation: q.explanation || '',
                        explanationImage: q.explanationImage || null,
                        id: index + 1
                    };
                });
                
                updates[`questions/week${weekNum}`] = questions;
                updates[`schedule/week${weekNum}`] = {
                    week: weekNum,
                    totalQuestions: 180,
                    lastUpdated: new Date().toISOString()
                };
                
                database.ref().update(updates)
                    .then(() => {
                        alert(`‚úÖ Successfully uploaded 180 questions for Week ${weekNum}!`);
                        loadWeekQuestions(weekNum);
                        document.getElementById('jsonUpload').value = '';
                    })
                    .catch(error => {
                        alert('‚ùå Error uploading: ' + error.message);
                    });
                    
            } catch (error) {
                alert('‚ùå Invalid JSON: ' + error.message);
            }
        }
        
        function addSingleQuestionWithImages() {
            const weekNum = currentSelectedWeek;
            const qNum = parseInt(document.getElementById('qNumber').value);
            
            if (!weekNum) {
                alert('Please select a week first.');
                return;
            }
            
            if (!qNum || qNum < 1 || qNum > 180) {
                alert('Please enter a valid question number between 1 and 180.');
                return;
            }
            
            const question = document.getElementById('questionText').value.trim();
            const optAText = document.getElementById('optA').value.trim();
            const optBText = document.getElementById('optB').value.trim();
            const optCText = document.getElementById('optC').value.trim();
            const optDText = document.getElementById('optD').value.trim();
            const answer = document.getElementById('correctOption').value;
            const explanation = document.getElementById('explanation').value.trim();
            
            if (!question) {
                alert('Please enter question text.');
                return;
            }
            
            if (!optAText || !optBText || !optCText || !optDText) {
                alert('Please fill all four options text.');
                return;
            }
            
            if (!answer) {
                alert('Please select the correct answer.');
                return;
            }
            
            // Create options object with text and images
            const options = {
                A: { text: optAText, image: currentOptionImages.A },
                B: { text: optBText, image: currentOptionImages.B },
                C: { text: optCText, image: currentOptionImages.C },
                D: { text: optDText, image: currentOptionImages.D }
            };
            
            const questionId = `q${qNum}`;
            const newQuestion = {
                question: question,
                questionImage: currentQuestionImage,
                options: options,
                answer: answer,
                explanation: explanation,
                explanationImage: currentExplanationImage,
                id: qNum
            };
            
            database.ref(`questions/week${weekNum}/${questionId}`).set(newQuestion)
                .then(() => {
                    // Clear form
                    document.getElementById('questionText').value = '';
                    document.getElementById('optA').value = '';
                    document.getElementById('optB').value = '';
                    document.getElementById('optC').value = '';
                    document.getElementById('optD').value = '';
                    document.getElementById('correctOption').value = '';
                    document.getElementById('explanation').value = '';
                    clearAllImages();
                    
                    loadWeekQuestions(weekNum);
                    alert('‚úÖ Question added successfully with all images!');
                })
                .catch(error => {
                    alert('‚ùå Error saving question: ' + error.message);
                });
        }
        
        function addAllSampleQuestions() {
            const weekNum = currentSelectedWeek;
            
            if (!weekNum) {
                alert('Please select a week first.');
                return;
            }
            
            if (confirm(`Add 180 sample questions for Week ${weekNum}?`)) {
                const questions = {};
                
                for (let i = 1; i <= 180; i++) {
                    const questionId = `q${i}`;
                    questions[questionId] = {
                        id: i,
                        question: `Sample question ${i} for Week ${weekNum}: Which of the following is correct?`,
                        questionImage: i % 10 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjEwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0Ij5RdWVzdGlvbiBJbWFnZTwvdGV4dD48L3N2Zz4=" : null,
                        options: {
                            A: { text: "Sample Option A", image: i % 7 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNSIgeT0iMjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+QTwvdGV4dD48L3N2Zz4=" : null },
                            B: { text: "Sample Option B", image: i % 8 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNSIgeT0iMjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+QjwvdGV4dD48L3N2Zz4=" : null },
                            C: { text: "Sample Option C", image: i % 9 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNSIgeT0iMjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+QzwvdGV4dD48L3N2Zz4=" : null },
                            D: { text: "Sample Option D", image: i % 11 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNSIgeT0iMjUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCI+RDwvdGV4dD48L3N2Zz4=" : null }
                        },
                        answer: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                        explanation: "This is a sample explanation. Admin should replace with actual content.",
                        explanationImage: i % 15 === 0 ? "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iMTAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPkV4cGxhbmF0aW9uPC90ZXh0Pjwvc3ZnPg==" : null
                    };
                }
                
                const updates = {};
                updates[`questions/week${weekNum}`] = questions;
                updates[`schedule/week${weekNum}`] = {
                    week: weekNum,
                    totalQuestions: 180,
                    lastUpdated: new Date().toISOString()
                };
                
                database.ref().update(updates)
                    .then(() => {
                        alert(`‚úÖ Added 180 sample questions for Week ${weekNum}`);
                        loadWeekQuestions(weekNum);
                    })
                    .catch(error => {
                        alert('‚ùå Error: ' + error.message);
                    });
            }
        }
        
        function deleteQuestion(weekNum, questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                database.ref(`questions/week${weekNum}/${questionId}`).remove()
                    .then(() => {
                        loadWeekQuestions(weekNum);
                        alert('‚úÖ Question deleted.');
                    })
                    .catch(error => {
                        alert('‚ùå Error deleting question: ' + error.message);
                    });
            }
        }
        
        function clearWeekQuestions() {
            const weekNum = currentSelectedWeek;
            
            if (confirm(`Are you sure you want to delete ALL questions for Week ${weekNum}?`)) {
                database.ref(`questions/week${weekNum}`).remove()
                    .then(() => {
                        database.ref(`schedule/week${weekNum}`).update({lastUpdated: new Date().toISOString()})
                            .then(() => {
                                loadWeekQuestions(weekNum);
                                alert('‚úÖ All questions cleared.');
                            });
                    })
                    .catch(error => {
                        alert('‚ùå Error clearing questions: ' + error.message);
                    });
            }
        }
        
        // ========== WEEK BOX STATUS ==========
        function updateWeekBoxStatus(weekNum, count) {
            const weekBox = document.querySelectorAll('.week-box')[weekNum - 1];
            if (!weekBox) return;
            
            weekBox.querySelector('.week-count').textContent = `${count}/180`;
            
            if (count >= 180) {
                weekBox.className = 'week-box full';
            } else if (count > 0) {
                weekBox.className = 'week-box partial';
            } else {
                weekBox.className = 'week-box empty';
            }
            
            weekBox.innerHTML = `
                <div class="week-number">Week ${weekNum}</div>
                <div class="week-count">${count}/180</div>
            `;
        }
        
        function updateAllWeekBoxes() {
            for (let weekNum = 1; weekNum <= 10; weekNum++) {
                database.ref(`questions/week${weekNum}`).once('value')
                    .then(snapshot => {
                        const count = snapshot.numChildren() || 0;
                        updateWeekBoxStatus(weekNum, count);
                    });
            }
        }
        
        // ========== USER MANAGEMENT ==========
        function loadAllUsers() {
            database.ref('users').once('value')
                .then(snapshot => {
                    const users = snapshot.val();
                    const tbody = document.getElementById('usersTable');
                    
                    tbody.innerHTML = '';
                    
                    if (!users) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #718096;">No students yet.</td></tr>';
                        return;
                    }
                    
                    Object.entries(users).forEach(([userId, user]) => {
                        const completedWeeks = user.completedWeeks || [];
                        const progress = Math.round((completedWeeks.length / 10) * 100);
                        
                        let totalScore = 0;
                        let totalTests = 0;
                        
                        if (user.scores) {
                            Object.values(user.scores).forEach(score => {
                                const percentage = Math.round((score.score / score.total) * 100);
                                totalScore += percentage;
                                totalTests++;
                            });
                        }
                        
                        const avgScore = totalTests > 0 ? (totalScore / totalTests).toFixed(1) : '0.0';
                        
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><strong>${user.fullName || 'N/A'}</strong></td>
                            <td>${user.username}</td>
                            <td>Week ${user.currentWeek || 1}</td>
                            <td>
                                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; width: 100px; display: inline-block; margin-right: 10px;">
                                    <div style="background: #48bb78; height: 100%; width: ${progress}%; border-radius: 4px;"></div>
                                </div>
                                ${progress}%
                            </td>
                            <td>${avgScore}%</td>
                            <td>${totalTests}</td>
                            <td>${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never'}</td>
                            <td>
                                <button onclick="viewUserProgress('${userId}')" style="padding: 5px 10px; font-size: 12px;">View</button>
                                <button onclick="resetUserProgress('${userId}')" style="padding: 5px 10px; font-size: 12px;" class="yellow">Reset</button>
                                <button onclick="deleteUser('${userId}')" style="padding: 5px 10px; font-size: 12px;" class="red">Delete</button>
                            </td>
                        `;
                    });
                });
        }
        
        function populateCertificateStudents() {
            database.ref('users').once('value')
                .then(snapshot => {
                    const users = snapshot.val();
                    const certSelect = document.getElementById('certStudent');
                    
                    certSelect.innerHTML = '<option value="">-- Select Student --</option>';
                    
                    if (!users) return;
                    
                    Object.entries(users).forEach(([userId, user]) => {
                        const completedWeeks = user.completedWeeks || [];
                        const progress = Math.round((completedWeeks.length / 10) * 100);
                        
                        const option = document.createElement('option');
                        option.value = userId;
                        option.textContent = `${user.fullName || user.username} (${progress}% complete)`;
                        certSelect.appendChild(option);
                    });
                });
        }
        
        function viewUserProgress(userId) {
            database.ref(`users/${userId}`).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    if (!user) {
                        alert('User not found');
                        return;
                    }
                    
                    let message = `Student: ${user.fullName}\n`;
                    message += `Username: ${user.username}\n`;
                    message += `Current Week: ${user.currentWeek || 1}\n`;
                    message += `Completed Weeks: ${user.completedWeeks ? user.completedWeeks.length : 0}/10\n`;
                    message += `Joined: ${new Date(user.createdAt).toLocaleDateString()}\n\n`;
                    
                    if (user.scores) {
                        message += `Test History:\n`;
                        Object.entries(user.scores).forEach(([weekKey, score]) => {
                            const weekNum = weekKey.replace('week', '');
                            const percentage = Math.round((score.score / score.total) * 100);
                            const date = new Date(score.dateCompleted);
                            message += `Week ${weekNum}: ${score.score}/${score.total} (${percentage}%) - ${date.toLocaleDateString()}\n`;
                        });
                    }
                    
                    alert(message);
                });
        }
        
        function resetUserProgress(userId) {
            if (confirm('Reset this student\'s progress to Week 1?')) {
                database.ref(`users/${userId}`).update({
                    currentWeek: 1,
                    completedWeeks: [],
                    scores: {}
                })
                .then(() => {
                    loadAllUsers();
                    populateCertificateStudents();
                    alert('‚úÖ Student progress reset to Week 1');
                })
                .catch(error => {
                    alert('‚ùå Error: ' + error.message);
                });
            }
        }
        
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this student and all their progress?')) {
                database.ref(`users/${userId}`).remove()
                    .then(() => {
                        loadAllUsers();
                        populateCertificateStudents();
                        alert('‚úÖ Student deleted.');
                    })
                    .catch(error => {
                        alert('‚ùå Error deleting student: ' + error.message);
                    });
            }
        }
        
        // ========== CERTIFICATE FUNCTIONS - ORIGINAL ==========
        function generateCertificate() {
            const userId = document.getElementById('certStudent').value;
            const certType = document.getElementById('certType').value;
            
            if (!userId) {
                alert('Please select a student.');
                return;
            }
            
            database.ref(`users/${userId}`).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    if (!user) {
                        alert('Student not found.');
                        return;
                    }
                    
                    currentSelectedUser = {id: userId, ...user};
                    
                    const completedWeeks = user.completedWeeks || [];
                    const totalWeeks = 10;
                    const progressPercent = Math.round((completedWeeks.length / totalWeeks) * 100);
                    
                    let totalScore = 0;
                    let totalTests = 0;
                    let bestScore = 0;
                    
                    if (user.scores) {
                        Object.values(user.scores).forEach(score => {
                            const percentage = Math.round((score.score / score.total) * 100);
                            totalScore += percentage;
                            totalTests++;
                            if (percentage > bestScore) bestScore = percentage;
                        });
                    }
                    
                    const avgScore = totalTests > 0 ? (totalScore / totalTests).toFixed(1) : '0.0';
                    
                    let certTitle = '';
                    switch(certType) {
                        case 'completion':
                            certTitle = 'Certificate of Completion';
                            break;
                        case 'progress':
                            certTitle = 'Progress Certificate';
                            break;
                        case 'excellence':
                            certTitle = 'Certificate of Excellence';
                            break;
                    }
                    
                    document.getElementById('certTitle').textContent = certTitle;
                    document.getElementById('certStudentName').textContent = user.fullName || user.username;
                    document.getElementById('certPerformance').textContent = `${avgScore}% Average Score`;
                    document.getElementById('certId').textContent = `NEET2026-${userId.substring(0, 8).toUpperCase()}`;
                    document.getElementById('certIssuedDate').textContent = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    document.getElementById('certificatePreview').style.display = 'block';
                    document.getElementById('certificatePreview').scrollIntoView({behavior: 'smooth'});
                });
        }
        
        function previewCertificate() {
            document.getElementById('certTitle').textContent = 'Certificate of Completion';
            document.getElementById('certStudentName').textContent = 'John Doe (Sample)';
            document.getElementById('certPerformance').textContent = '92% Average Score';
            document.getElementById('certId').textContent = 'NEET2026-SAMPLE123';
            document.getElementById('certIssuedDate').textContent = new Date().toLocaleDateString();
            
            document.getElementById('certificatePreview').style.display = 'block';
        }
        
        function printCertificate() {
            if (!currentSelectedUser) {
                alert('Please generate a certificate first.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>NEET Certificate - ${currentSelectedUser.fullName || currentSelectedUser.username}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }
                        .certificate { border: 5px solid gold; padding: 60px; margin: 20px auto; max-width: 800px; 
                            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); }
                        .title { color: #1e3a8a; font-size: 36px; margin-bottom: 30px; text-transform: uppercase; }
                        .name { color: #3730a3; font-size: 42px; margin: 30px 0; padding: 15px; border-bottom: 3px solid #fbbf24; }
                        .details { background: rgba(255,255,255,0.9); padding: 30px; margin: 30px 0; border-radius: 15px; }
                    </style>
                </head>
                <body>
                    <div class="certificate">
                        <h1 class="title">${document.getElementById('certTitle').textContent}</h1>
                        <p style="font-size: 20px; color: #4b5563;">This is to certify that</p>
                        <h2 class="name">${currentSelectedUser.fullName || currentSelectedUser.username}</h2>
                        <p style="font-size: 18px; color: #6b7280; line-height: 1.6;">
                            has successfully completed the 10-week NEET preparation program<br>
                            demonstrating exceptional dedication and commitment to academic excellence.
                        </p>
                        <div class="details">
                            <p><strong>Program Duration:</strong> 10 Weeks (Feb 19 - May 3, 2026)</p>
                            <p><strong>Overall Performance:</strong> ${document.getElementById('certPerformance').textContent}</p>
                            <p><strong>Certificate ID:</strong> ${document.getElementById('certId').textContent}</p>
                            <p><strong>Issued Date:</strong> ${document.getElementById('certIssuedDate').textContent}</p>
                        </div>
                        <div style="margin-top: 40px;">
                            <p style="color: #6b7280;"><strong>Official Seal:</strong> NEET Preparation Portal</p>
                            <p style="color: #6b7280;"><strong>Issuing Authority:</strong> NEET Exam Preparation Committee</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function downloadCertificate() {
            if (!currentSelectedUser) {
                alert('Please generate a certificate first.');
                return;
            }
            
            const certificateHTML = `
                <html>
                <head>
                    <title>NEET Certificate - ${currentSelectedUser.fullName || currentSelectedUser.username}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }
                        .certificate { border: 5px solid gold; padding: 60px; margin: 20px auto; max-width: 800px; 
                            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); }
                        .title { color: #1e3a8a; font-size: 36px; margin-bottom: 30px; text-transform: uppercase; }
                        .name { color: #3730a3; font-size: 42px; margin: 30px 0; padding: 15px; border-bottom: 3px solid #fbbf24; }
                        .details { background: rgba(255,255,255,0.9); padding: 30px; margin: 30px 0; border-radius: 15px; }
                    </style>
                </head>
                <body>
                    <div class="certificate">
                        <h1 class="title">${document.getElementById('certTitle').textContent}</h1>
                        <p style="font-size: 20px; color: #4b5563;">This is to certify that</p>
                        <h2 class="name">${currentSelectedUser.fullName || currentSelectedUser.username}</h2>
                        <p style="font-size: 18px; color: #6b7280; line-height: 1.6;">
                            has successfully completed the 10-week NEET preparation program<br>
                            demonstrating exceptional dedication and commitment to academic excellence.
                        </p>
                        <div class="details">
                            <p><strong>Program Duration:</strong> 10 Weeks (Feb 19 - May 3, 2026)</p>
                            <p><strong>Overall Performance:</strong> ${document.getElementById('certPerformance').textContent}</p>
                            <p><strong>Certificate ID:</strong> ${document.getElementById('certId').textContent}</p>
                            <p><strong>Issued Date:</strong> ${document.getElementById('certIssuedDate').textContent}</p>
                        </div>
                        <div style="margin-top: 40px;">
                            <p style="color: #6b7280;"><strong>Official Seal:</strong> NEET Preparation Portal</p>
                            <p style="color: #6b7280;"><strong>Issuing Authority:</strong> NEET Exam Preparation Committee</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([certificateHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NEET_Certificate_${currentSelectedUser.username}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function goToWeekEdit() {
            showTab('upload');
            loadWeekQuestions(currentSelectedWeek);
        }
        
        // Search functionality
        document.getElementById('searchUser').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
